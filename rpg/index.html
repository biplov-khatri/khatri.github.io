<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Frame Generation</title>

    <!-- Bootstrap CSS -->
    <link href="css/style.css" rel="stylesheet" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">

    <link rel="icon" type="image/x-icon" href="img/favicon.ico">

    <!-- Open Graph meta tags -->
    <meta property="og:title" content="" />
    <meta property="og:url" content="" />
    <meta property="og:image" content="" />
    <meta property="og:type" content="article" />
    <meta property="og:description" content="" />

    <!-- Other meta tags -->
    <meta name="description" content="This is a tool to design the NRNA Chiba Festival. You can select your favorite photo to create a festival banner and request to make the festival successful.">
    <!-- Link to the thumbnail image -->
    <link rel="image_src" href="img/thumbnail.png">

    <!-- External Stylesheets -->
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <script type="text/javascript" src="js/caman.full.js"></script>
	<main>
        <header>
            <div class="logo">
                <img src="logo.png" alt="NRNA Chiba Festival Logo" />
            </div>
        </header>

        <h1>NRNA Chiba Nepal Festival 2024</h1>
        <div class="description">
            This is a tool to design the NRNA Chiba Festival. You can select your favorite photo to create a festival banner and request to make the festival successful.
        </div>
        <div class="upload-img">
            <input type="file" accept="image/*" onchange="loadFile(event)" id="file" class="inputfile" />
            <label for="file">Choose Photo</label>
        </div>

        <div class="center photo-frame">
            <img id="overlay-img" src="plain.png" alt="Overlay Image" style="cursor: pointer;" onclick="triggerFileInput()" />
        </div>

        <div class="center">
            <button id="downloadBtn" class="btn blue-btn" style="display: none;" onclick="downloadImage()">Download Photo</button>
        </div>

        <section class="company-logo" style="border-bottom: 1px solid rgb(170, 170, 170); padding: 30px;">
            <h2>Festival Supporters</h2>
            <div class="description info">
                We, the NRNA Chiba family, would like to express our gratitude to various organizations for their support and cooperation in making the NRNA Chiba Nepal Festival 2024 successful. Let's all come together to make this Chiba Nepal Festival 2024 grand and successful.
            </div>
            <div class="company-logo-animation"></div>
        </section>

        <div class="madeBy">Made by <a href="https://khatori.net" target="_blank">Khatori Tech</a> using <a href="#" target="_blank">CamanJS</a></div>
    </main>

	<script src="js/script.js"></script> <!-- Assuming the JavaScript has been moved to an external file named script.js -->
    <script src="js/drag-and-zoom.js"></script> <!-- New script for drag and zoom functionality -->
    <script src="https://unpkg.com/cropperjs"></script>
    <script>
        let cropper; // Cropper instance
        const imageElement = document.getElementById('overlay-img');
        const fileInput = document.getElementById('file');
        const previewCanvas = document.createElement('canvas'); // Create a new canvas for overlay
        const downloadBtn = document.getElementById('downloadBtn');

        // Function to trigger file input
        function triggerFileInput() {
            fileInput.click();
        }

        // Function to handle file selection
        function loadFile(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imageElement.src = e.target.result;
                    imageElement.style.cursor = 'default'; // Disable click event
                    fileInput.style.display = 'none'; // Hide file input

                    // Initialize Cropper
                    if (cropper) {
                        cropper.destroy();
                    }
                    cropper = new Cropper(imageElement, {
                        aspectRatio: 1, // 1:1 aspect ratio
                        viewMode: 2,
                        autoCropArea: 1,
                        dragMode: 'move', // Enable dragging
                        zoomable: false, // Disable zooming
                        scalable: false, // Disable scaling
                        cropBoxResizable: false, // Disable resizing of crop box
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        // Function to confirm crop
        function confirmCrop() {
            const croppedCanvas = cropper.getCroppedCanvas({
                width: 730,
                height: 730
            });

            // Set canvas settings
            previewCanvas.style.maxWidth = '100%'; // Set max-width for the preview canvas
            previewCanvas.width = 1200;
            previewCanvas.height = 1200;
            const context = previewCanvas.getContext('2d');

            // Draw cropped image as background
            context.drawImage(croppedCanvas, 0, 0, 1200, 1200); // Draw as background

            // Draw overlay image
            const overlayImage = new Image();
            overlayImage.src = 'overlay.png'; // 1200x1200px, transparent parts at top and bottom

            overlayImage.onload = function() {
                // Draw entire overlay image
                context.drawImage(overlayImage, 0, 0, 1200, 1200);

                // Display in photo-frame div container
                const photoFrame = document.querySelector('.photo-frame');
                photoFrame.innerHTML = ''; // Clear previous content
                const overlayCanvas = document.createElement('canvas');
                overlayCanvas.width = 1200;
                overlayCanvas.height = 1200;
                overlayCanvas.style.maxWidth = '100%'; // Set max-width for the preview canvas
                const overlayContext = overlayCanvas.getContext('2d');
                overlayContext.drawImage(previewCanvas, 0, 0);
                photoFrame.appendChild(overlayCanvas); // Append the overlay canvas

                // Show download button
                downloadBtn.style.display = 'block';
                
                // Hide Cropper UI
                cropper.destroy(); // Destroy Cropper
            };
        }

        // Function to download image
        function downloadImage() {
            const link = document.createElement('a');
            link.href = previewCanvas.toDataURL('image/png');
            link.download = 'cropped_overlay_image.png';
            link.click();
        }
    </script>
</body>
</html>
